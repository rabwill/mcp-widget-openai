<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Zava Insurance Claims</title>
    <!-- React and ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      /* Light mode (default) */
      :root {
        --primary: #2563eb;
        --primary-light: #3b82f6;
        --primary-dark: #1d4ed8;
        --success: #059669;
        --success-light: #10b981;
        --warning: #d97706;
        --warning-light: #f59e0b;
        --danger: #dc2626;
        --danger-light: #ef4444;
        --info: #0891b2;
        --bg-light: #f8fafc;
        --bg-card: #ffffff;
        --text-primary: #0f172a;
        --text-secondary: #64748b;
        --text-muted: #94a3b8;
        --border: #e2e8f0;
        --border-light: #f1f5f9;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        
        /* Status badge colors - light mode */
        --status-pending-bg: #fef3c7;
        --status-pending-text: #92400e;
        --status-investigation-bg: #dbeafe;
        --status-investigation-text: #1e40af;
        --status-approved-bg: #d1fae5;
        --status-approved-text: #065f46;
        --status-denied-bg: #fee2e2;
        --status-denied-text: #991b1b;
        --status-closed-bg: #e2e8f0;
        --status-closed-text: #475569;
      }

      /* Dark mode */
      .dark {
        --primary: #3b82f6;
        --primary-light: #60a5fa;
        --primary-dark: #2563eb;
        --success: #10b981;
        --success-light: #34d399;
        --warning: #f59e0b;
        --warning-light: #fbbf24;
        --danger: #ef4444;
        --danger-light: #f87171;
        --info: #22d3ee;
        --bg-light: #1a1a1a;
        --bg-card: #2d2d2d;
        --text-primary: #f1f5f9;
        --text-secondary: #a1a1aa;
        --text-muted: #71717a;
        --border: #3f3f46;
        --border-light: #27272a;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -4px rgba(0, 0, 0, 0.4);
        
        /* Status badge colors - dark mode */
        --status-pending-bg: #451a03;
        --status-pending-text: #fbbf24;
        --status-investigation-bg: #1e3a5f;
        --status-investigation-text: #93c5fd;
        --status-approved-bg: #064e3b;
        --status-approved-text: #6ee7b7;
        --status-denied-bg: #450a0a;
        --status-denied-text: #fca5a5;
        --status-closed-bg: #27272a;
        --status-closed-text: #a1a1aa;
      }

      /* Also support prefers-color-scheme for fallback */
      @media (prefers-color-scheme: dark) {
        :root:not(.light) {
          --primary: #3b82f6;
          --primary-light: #60a5fa;
          --primary-dark: #2563eb;
          --success: #10b981;
          --success-light: #34d399;
          --warning: #f59e0b;
          --warning-light: #fbbf24;
          --danger: #ef4444;
          --danger-light: #f87171;
          --info: #22d3ee;
          --bg-light: #1a1a1a;
          --bg-card: #2d2d2d;
          --text-primary: #f1f5f9;
          --text-secondary: #a1a1aa;
          --text-muted: #71717a;
          --border: #3f3f46;
          --border-light: #27272a;
          --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
          --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -4px rgba(0, 0, 0, 0.4);
          
          --status-pending-bg: #451a03;
          --status-pending-text: #fbbf24;
          --status-investigation-bg: #1e3a5f;
          --status-investigation-text: #93c5fd;
          --status-approved-bg: #064e3b;
          --status-approved-text: #6ee7b7;
          --status-denied-bg: #450a0a;
          --status-denied-text: #fca5a5;
          --status-closed-bg: #27272a;
          --status-closed-text: #a1a1aa;
        }
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html, body {
        width: 100%;
        min-height: 100%;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--bg-light);
        color: var(--text-primary);
        line-height: 1.5;
        overflow-x: hidden;
        overflow-y: auto;
      }

      body {
        /* padding: 16px;
        overflow-x: hidden; */
        max-width: 100vw;
      }

      #root {
        max-width: 900px;
        margin: 0 auto;
        width: 100%;
      }

      /* Loading State */
      .loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        color: var(--text-secondary);
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--border);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 16px;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* Header */
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 24px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border);
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .logo {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 20px;
        box-shadow: var(--shadow);
      }

      .header-text h1 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
      }

      .header-text p {
        font-size: 0.875rem;
        color: var(--text-secondary);
      }

      /* Stats Bar */
      .stats-bar {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
        margin-bottom: 24px;
      }

      .stat-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px 12px;
        text-align: center;
        box-shadow: var(--shadow);
        overflow: hidden;
        min-width: 0;
      }

      .stat-value {
        font-size: clamp(1.25rem, 4vw, 1.75rem);
        font-weight: 700;
        color: var(--primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .stat-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 4px;
      }

      .stat-card.warning .stat-value { color: var(--warning); }
      .stat-card.success .stat-value { color: var(--success); }
      .stat-card.danger .stat-value { color: var(--danger); }

      /* Back Button */
      .back-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s ease;
        margin-bottom: 16px;
      }

      .back-btn:hover {
        border-color: var(--primary);
        color: var(--primary);
        background: var(--bg-light);
      }

      /* Claims List */
      .claims-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .claim-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: var(--shadow);
      }

      .claim-card:hover {
        border-color: var(--primary);
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
      }

      .claim-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 16px;
      }

      .claim-number {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--primary);
      }

      .claim-holder {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-top: 4px;
      }

      .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        white-space: nowrap;
      }

      .status-pending {
        background: var(--status-pending-bg);
        color: var(--status-pending-text);
      }

      .status-investigation {
        background: var(--status-investigation-bg);
        color: var(--status-investigation-text);
      }

      .status-approved {
        background: var(--status-approved-bg);
        color: var(--status-approved-text);
      }

      .status-denied {
        background: var(--status-denied-bg);
        color: var(--status-denied-text);
      }

      .status-closed {
        background: var(--status-closed-bg);
        color: var(--status-closed-text);
      }

      .claim-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
      }

      .detail-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .detail-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .detail-value {
        font-size: 0.875rem;
        color: var(--text-primary);
        font-weight: 500;
      }

      .detail-value.amount {
        color: var(--success);
        font-weight: 700;
      }

      .damage-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 12px;
      }

      .damage-tag {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        background: var(--bg-light);
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 0.75rem;
        color: var(--text-secondary);
      }

      /* Claim Detail View */
      .claim-detail-view {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 16px;
        overflow: hidden;
        box-shadow: var(--shadow-lg);
      }

      .detail-header {
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        color: white;
        padding: 24px;
      }

      .detail-header .claim-number {
        color: white;
        font-size: 1.5rem;
        margin-bottom: 8px;
      }

      .detail-header .claim-holder {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1rem;
      }

      .detail-body {
        padding: 24px;
      }

      .detail-section {
        margin-bottom: 24px;
      }

      .detail-section:last-child {
        margin-bottom: 0;
      }

      .section-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border-light);
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
      }

      .info-item {
        background: var(--bg-light);
        border-radius: 10px;
        padding: 16px;
      }

      .info-item .label {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
      }

      .info-item .value {
        font-size: 1rem;
        color: var(--text-primary);
        font-weight: 500;
      }

      .info-item .value.large {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--success);
      }

      .description-box {
        background: var(--bg-light);
        border-radius: 10px;
        padding: 16px;
        font-size: 0.9375rem;
        line-height: 1.6;
        color: var(--text-primary);
      }

      .notes-list {
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .notes-list li {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 12px 16px;
        background: var(--bg-light);
        border-radius: 8px;
        font-size: 0.875rem;
      }

      .notes-list li::before {
        content: "‚Ä¢";
        color: var(--primary);
        font-weight: 700;
        flex-shrink: 0;
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
      }

      .empty-icon {
        font-size: 3rem;
        margin-bottom: 16px;
      }

      /* Responsive */
      @media (max-width: 600px) {
        body {
          padding: 12px;
        }

        .header {
          flex-direction: column;
          align-items: flex-start;
        }

        .stats-bar {
          grid-template-columns: repeat(2, 1fr);
        }

        .claim-header {
          flex-direction: column;
        }

        .claim-details {
          grid-template-columns: 1fr;
        }
      }
    </style>
    <script>
      // Apply theme from OpenAI Apps SDK immediately (before React loads)
      (function() {
        function applyTheme(theme) {
          const root = document.documentElement;
          if (theme === 'dark') {
            root.classList.add('dark');
            root.classList.remove('light');
          } else if (theme === 'light') {
            root.classList.add('light');
            root.classList.remove('dark');
          }
        }
        
        // Check for initial theme from window.openai
        if (window.openai && window.openai.theme) {
          applyTheme(window.openai.theme);
        }
        
        // Listen for theme changes from OpenAI Apps SDK
        window.addEventListener('openai:set_globals', function(event) {
          if (event.detail && event.detail.globals && event.detail.globals.theme) {
            applyTheme(event.detail.globals.theme);
          }
        });
      })();
    </script>
  </head>
  <body>
    <div id="root">
      <div class="loading">
        <div class="spinner"></div>
        <p>Loading claims data...</p>
      </div>
    </div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      // Status badge helper
      const getStatusClass = (status) => {
        const s = status?.toLowerCase() || '';
        if (s.includes('pending')) return 'status-pending';
        if (s.includes('investigation') || s.includes('review')) return 'status-investigation';
        if (s.includes('approved') || s.includes('settled')) return 'status-approved';
        if (s.includes('denied') || s.includes('rejected')) return 'status-denied';
        if (s.includes('closed')) return 'status-closed';
        return 'status-pending';
      };

      // Format currency
      const formatCurrency = (amount) => {
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        }).format(amount || 0);
      };

      // Format date
      const formatDate = (dateStr) => {
        if (!dateStr) return 'N/A';
        return new Date(dateStr).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
        });
      };

      // Get short status text
      const getShortStatus = (status) => {
        if (!status) return 'Unknown';
        const parts = status.split(' - ');
        return parts[0] || status;
      };

      // Stats Bar Component
      const StatsBar = ({ claims }) => {
        const totalAmount = claims.reduce((sum, c) => sum + (c.estimatedLoss || 0), 0);
        const pendingCount = claims.filter(c => c.status?.toLowerCase().includes('pending')).length;
        const investigationCount = claims.filter(c => c.status?.toLowerCase().includes('investigation')).length;

        return (
          <div className="stats-bar">
            <div className="stat-card">
              <div className="stat-value">{claims.length}</div>
              <div className="stat-label">Total Claims</div>
            </div>
            <div className="stat-card warning">
              <div className="stat-value">{pendingCount}</div>
              <div className="stat-label">Pending</div>
            </div>
            <div className="stat-card">
              <div className="stat-value">{investigationCount}</div>
              <div className="stat-label">Under Review</div>
            </div>
            <div className="stat-card success">
              <div className="stat-value">{formatCurrency(totalAmount)}</div>
              <div className="stat-label">Total Value</div>
            </div>
          </div>
        );
      };

      // Claim Card Component (List View)
      const ClaimCard = ({ claim, onClick }) => (
        <div className="claim-card" onClick={() => onClick(claim)}>
          <div className="claim-header">
            <div>
              <div className="claim-number">{claim.claimNumber}</div>
              <div className="claim-holder">{claim.policyHolderName} ‚Ä¢ {claim.policyHolderEmail}</div>
            </div>
            <span className={`status-badge ${getStatusClass(claim.status)}`}>
              {getShortStatus(claim.status)}
            </span>
          </div>
          <div className="claim-details">
            <div className="detail-item">
              <span className="detail-label">Property</span>
              <span className="detail-value">{claim.property}</span>
            </div>
            <div className="detail-item">
              <span className="detail-label">Date of Loss</span>
              <span className="detail-value">{formatDate(claim.dateOfLoss)}</span>
            </div>
            <div className="detail-item">
              <span className="detail-label">Estimated Loss</span>
              <span className="detail-value amount">{formatCurrency(claim.estimatedLoss)}</span>
            </div>
          </div>
          {claim.damageTypes && claim.damageTypes.length > 0 && (
            <div className="damage-tags">
              {claim.damageTypes.map((damage, i) => (
                <span key={i} className="damage-tag">{damage}</span>
              ))}
            </div>
          )}
        </div>
      );

      // Claim Detail View Component
      const ClaimDetailView = ({ claim, onBack }) => (
        <div>
          <button className="back-btn" onClick={onBack}>
            ‚Üê Back to Claims List
          </button>
          <div className="claim-detail-view">
            <div className="detail-header">
              <div className="claim-number">{claim.claimNumber}</div>
              <div className="claim-holder">{claim.policyHolderName}</div>
              <div style={{ marginTop: '12px' }}>
                <span className={`status-badge ${getStatusClass(claim.status)}`}>
                  {getShortStatus(claim.status)}
                </span>
              </div>
            </div>
            <div className="detail-body">
              {/* Claim Overview */}
              <div className="detail-section">
                <div className="section-title">Claim Overview</div>
                <div className="info-grid">
                  <div className="info-item">
                    <div className="label">Claim ID</div>
                    <div className="value">{claim.id}</div>
                  </div>
                  <div className="info-item">
                    <div className="label">Policy Number</div>
                    <div className="value">{claim.policyNumber}</div>
                  </div>
                  <div className="info-item">
                    <div className="label">Estimated Loss</div>
                    <div className="value large">{formatCurrency(claim.estimatedLoss)}</div>
                  </div>
                  <div className="info-item">
                    <div className="label">Adjuster Assigned</div>
                    <div className="value">{claim.adjusterAssigned || 'Unassigned'}</div>
                  </div>
                </div>
              </div>

              {/* Property & Contact */}
              <div className="detail-section">
                <div className="section-title">Property & Contact</div>
                <div className="info-grid">
                  <div className="info-item">
                    <div className="label">Property Address</div>
                    <div className="value">{claim.property}</div>
                  </div>
                  <div className="info-item">
                    <div className="label">Policy Holder</div>
                    <div className="value">{claim.policyHolderName}</div>
                  </div>
                  <div className="info-item">
                    <div className="label">Email</div>
                    <div className="value">{claim.policyHolderEmail}</div>
                  </div>
                </div>
              </div>

              {/* Dates */}
              <div className="detail-section">
                <div className="section-title">Timeline</div>
                <div className="info-grid">
                  <div className="info-item">
                    <div className="label">Date of Loss</div>
                    <div className="value">{formatDate(claim.dateOfLoss)}</div>
                  </div>
                  <div className="info-item">
                    <div className="label">Date Reported</div>
                    <div className="value">{formatDate(claim.dateReported)}</div>
                  </div>
                  <div className="info-item">
                    <div className="label">Created</div>
                    <div className="value">{formatDate(claim.createdAt)}</div>
                  </div>
                  <div className="info-item">
                    <div className="label">Last Updated</div>
                    <div className="value">{formatDate(claim.updatedAt)}</div>
                  </div>
                </div>
              </div>

              {/* Damage Types */}
              {claim.damageTypes && claim.damageTypes.length > 0 && (
                <div className="detail-section">
                  <div className="section-title">Damage Types</div>
                  <div className="damage-tags" style={{ marginTop: 0 }}>
                    {claim.damageTypes.map((damage, i) => (
                      <span key={i} className="damage-tag">{damage}</span>
                    ))}
                  </div>
                </div>
              )}

              {/* Description */}
              <div className="detail-section">
                <div className="section-title">Description</div>
                <div className="description-box">
                  {claim.description || 'No description provided.'}
                </div>
              </div>

              {/* Status Details */}
              <div className="detail-section">
                <div className="section-title">Status Details</div>
                <div className="description-box">
                  {claim.status || 'Status not available.'}
                </div>
              </div>

              {/* Notes */}
              {claim.notes && claim.notes.length > 0 && (
                <div className="detail-section">
                  <div className="section-title">Notes</div>
                  <ul className="notes-list">
                    {claim.notes.map((note, i) => (
                      <li key={i}>{note}</li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
          </div>
        </div>
      );

      // Claims List Component
      const ClaimsList = ({ claims, onSelectClaim }) => {
        if (!claims || claims.length === 0) {
          return (
            <div className="empty-state">
              <div className="empty-icon">üìã</div>
              <h3>No Claims Found</h3>
              <p>There are no insurance claims to display.</p>
            </div>
          );
        }

        return (
          <div className="claims-list">
            {claims.map((claim) => (
              <ClaimCard 
                key={claim.id || claim.claimNumber} 
                claim={claim} 
                onClick={onSelectClaim} 
              />
            ))}
          </div>
        );
      };

      // Main App Component
      const App = () => {
        const [claims, setClaims] = useState([]);
        const [selectedClaim, setSelectedClaim] = useState(null);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);

        // Helper function to extract claims from tool output data
        const extractClaims = (data) => {
          if (!data) return null;
          
          // Handle different data structures from the MCP server
          // The server returns: { success: true, data: [...claims], message: '...' }
          if (data.success && data.data) {
            if (Array.isArray(data.data)) {
              return { claims: data.data, single: false };
            } else if (data.data.claims) {
              return { claims: data.data.claims, single: false };
            } else if (typeof data.data === 'object') {
              // Single claim object
              return { claims: [data.data], single: true };
            }
          }
          
          // Direct claims array
          if (data.claims && Array.isArray(data.claims)) {
            return { claims: data.claims, single: false };
          }
          
          // Single claim object at root
          if (data.claim) {
            return { claims: [data.claim], single: true };
          }
          
          // Direct array
          if (Array.isArray(data)) {
            return { claims: data, single: data.length === 1 };
          }
          
          return null;
        };

        useEffect(() => {
          // Function to load data from OpenAI Apps SDK bridge
          const loadData = () => {
            try {
              // Check for OpenAI Apps SDK data via window.openai.toolOutput
              if (window.openai && window.openai.toolOutput) {
                const data = window.openai.toolOutput;
                console.log('OpenAI Apps SDK toolOutput received:', data);

                const extracted = extractClaims(data);
                if (extracted && extracted.claims.length > 0) {
                  setClaims(extracted.claims);
                  if (extracted.single) {
                    setSelectedClaim(extracted.claims[0]);
                  }
                  setLoading(false);
                  return true;
                }
              }
              return false;
            } catch (err) {
              console.error('Error loading data:', err);
              setError(err.message);
              setLoading(false);
              return false;
            }
          };

          // Listen for OpenAI Apps SDK set_globals events for reactive updates
          const handleSetGlobals = (event) => {
            console.log('OpenAI set_globals event received:', event.detail);
            if (event.detail && event.detail.globals && event.detail.globals.toolOutput) {
              const data = event.detail.globals.toolOutput;
              console.log('Updated toolOutput:', data);
              
              const extracted = extractClaims(data);
              if (extracted && extracted.claims.length > 0) {
                setClaims(extracted.claims);
                if (extracted.single) {
                  setSelectedClaim(extracted.claims[0]);
                }
                setLoading(false);
              }
            }
          };

          // Add event listener for OpenAI Apps SDK updates
          window.addEventListener('openai:set_globals', handleSetGlobals);

          // Try to load immediately if data is already available
          if (!loadData()) {
            // If no data yet, set up polling as fallback
            const checkInterval = setInterval(() => {
              if (loadData()) {
                clearInterval(checkInterval);
              }
            }, 100);

            // Give up after 5 seconds
            setTimeout(() => {
              clearInterval(checkInterval);
              if (loading) {
                console.log('No data received, widget ready for data');
                setLoading(false);
              }
            }, 5000);
          }

          // Cleanup event listener on unmount
          return () => {
            window.removeEventListener('openai:set_globals', handleSetGlobals);
          };
        }, []);

        // Handle going back to list
        const handleBack = () => {
          setSelectedClaim(null);
        };

        // Handle selecting a claim
        const handleSelectClaim = (claim) => {
          setSelectedClaim(claim);
        };

        if (loading) {
          return (
            <div className="loading">
              <div className="spinner"></div>
              <p>Loading claims data...</p>
            </div>
          );
        }

        if (error) {
          return (
            <div className="empty-state">
              <div className="empty-icon">‚ö†Ô∏è</div>
              <h3>Error Loading Data</h3>
              <p>{error}</p>
            </div>
          );
        }

        return (
          <div>
            {/* Header */}
            <div className="header">
              <div className="header-left">
                <div className="logo">Z</div>
                <div className="header-text">
                  <h1>Zava Insurance Claims</h1>
                  <p>
                    {selectedClaim 
                      ? `Viewing claim ${selectedClaim.claimNumber}` 
                      : `${claims.length} claim${claims.length !== 1 ? 's' : ''} found`}
                  </p>
                </div>
              </div>
            </div>

            {/* Content */}
            {selectedClaim ? (
              <ClaimDetailView claim={selectedClaim} onBack={handleBack} />
            ) : (
              <>
                {claims.length > 0 && <StatsBar claims={claims} />}
                <ClaimsList claims={claims} onSelectClaim={handleSelectClaim} />
              </>
            )}
          </div>
        );
      };

      // Render the app
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
